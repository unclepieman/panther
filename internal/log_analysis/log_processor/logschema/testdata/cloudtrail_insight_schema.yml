# Panther is a Cloud-Native SIEM for the Modern Security Team.
# Copyright (C) 2020 Panther Labs Inc
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# Copyright (C) 2020 Panther Labs Inc
#
# Panther Enterprise is licensed under the terms of a commercial license available from
# Panther Labs Inc ("Panther Commercial License") by contacting contact@runpanther.com.
# All use, distribution, and/or modification of this software, whether commercial or non-commercial,
# falls under the Panther Commercial License to the extent it is permitted.

schema: CloudTrailInsight
version: 0
fields:
  - name: eventVersion
    required: true
    type: string
    description: The version of the log event format.
  - name: eventTime
    required: true
    description: The date and time the request was made, in coordinated universal time (UTC).
    type: timestamp
    timeFormat: rfc3339
    isEventTime: true
  - name: awsRegion
    required: true
    type: string
    description: The AWS region that the request was made to, such as us-east-2.
  - name: eventID
    type: string
    required: true
    description: |
      GUID generated by CloudTrail to uniquely identify each event.
      You can use this value to identify a single event.
      For example, you can use the ID as a primary key to retrieve log data
      from a searchable database.
  - name: eventType
    required: true
    type: string
    description: Identifies the type of event that generated the event record.
  - name: recipientAccountId
    type: string
    indicator: aws_account_id
    description: |
      GUID generated by CloudTrail to uniquely identify each event.
      You can use this value to identify a single event.
      For example, you can use the ID as a primary key to retrieve log data from a searchable database.
  - name: sharedEventID
    required: true
    type: string
    indicator: trace_id
    description: |
      A GUID that is generated by CloudTrail Insights to uniquely identify an Insights event.
      sharedEventId is common between the start and the end Insights events.
  - name: insightDetails
    required: true
    type: ref
    target: insightDetails
    description: |
      Shows information about the underlying triggers of an Insights event, such as event source, statistics,
      API name, and whether the event is the start or end of the Insights event
  - name: eventCategory
    required: true
    type: string
    description: Shows the event category that is used in LookupEvents calls. In Insights events, the value is insight.
definitions:
  InsightDetails:
    type: object
    fields:
      - name: state
        required: true
        type: string
        description: Shows whether the event represents the start or end of the insight (the start or end of unusual activity). Values are Start or End.
      - name: eventSource
        type: string
        required: true
        description: The AWS API for which unusual activity was detected.
      - name: eventName
        type: string
        description: The name of the event for which unusual activity was detected.
        required: true
      - name: insightType
        type: string
        required: true
        description: The type of Insights event. Value is ApiCallRateInsight.
      - name: insightContext
        type: ref
        target: InsightContext
        description: Data about the rate of calls that triggered the Insights event compared to the normal rate of calls to the subject API per minute.
  InsightContext:
    type: object
    fields:
      - name: statistics
        type: object
        description: |
          A container for data about the typical average rate of calls to the subject API by an account,
          the rate of calls that triggered the Insights event, and the duration, in minutes, of the Insights event.
        fields:
          - name: baseline
            type: ref
            description: Shows the typical average rate of calls to the subject API by an account within a specific AWS Region.
            target: InsightMetric
          - name: insight
            type: ref
            description: Shows the unusual rate of calls to the subject API that triggers the logging of an Insights event.
            target: InsightMetric
          - name: insightDuration
            type: float
            description: |
              The duration, in minutes, of an Insights event (the time period from the start to the end of unusual activity on the subject API).
              insightDuration only occurs in end Insights events.
  InsightMetric:
    type: object
    fields:
      - name: average
        type: float
        description: Average value for the insight metric
