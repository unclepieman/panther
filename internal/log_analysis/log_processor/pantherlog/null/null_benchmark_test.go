package null_test

/**
 * Panther is a Cloud-Native SIEM for the Modern Security Team.
 * Copyright (C) 2020 Panther Labs Inc
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

import (
	"testing"

	jsoniter "github.com/json-iterator/go"

	"github.com/panther-labs/panther/internal/log_analysis/log_processor/pantherlog/null"
	"github.com/panther-labs/panther/internal/log_analysis/log_processor/parsers/testutil"
	"github.com/panther-labs/panther/internal/log_analysis/log_processor/parsers/timestamp"
)

func BenchmarkNullTypes(b *testing.B) {
	{
		//nolint:lll
		input := `{"eventVersion":"1.05","userIdentity":{"type":"AWSService","invokedBy":"cloudtrail.amazonaws.com"},"eventTime":"2018-08-26T14:17:23Z","eventSource":"kms.amazonaws.com","eventName":"GenerateDataKey","awsRegion":"us-west-2","sourceIPAddress":"cloudtrail.amazonaws.com","userAgent":"cloudtrail.amazonaws.com","requestParameters":{"keySpec":"AES_256","encryptionContext":{"aws:cloudtrail:arn":"arn:aws:cloudtrail:us-west-2:888888888888:trail/panther-lab-cloudtrail","aws:s3:arn":"arn:aws:s3:::panther-lab-cloudtrail/AWSLogs/888888888888/CloudTrail/us-west-2/2018/08/26/888888888888_CloudTrail_us-west-2_20180826T1410Z_inUwlhwpSGtlqmIN.json.gz"},"keyId":"arn:aws:kms:us-west-2:888888888888:key/72c37aae-1000-4058-93d4-86374c0fe9a0"},"responseElements":null,"requestID":"3cff2472-5a91-4bd9-b6d2-8a7a1aaa9086","eventID":"7a215e16-e0ad-4f6c-82b9-33ff6bbdedd2","readOnly":true,"resources":[{"ARN":"arn:aws:kms:us-west-2:888888888888:key/72c37aae-1000-4058-93d4-86374c0fe9a0","accountId":"888888888888","type":"AWS::KMS::Key"}],"eventType":"AwsApiCall","recipientAccountId":"777777777777","sharedEventID":"238c190c-1a30-4756-8e08-19fc36ad1b9f"}`
		raw := []byte(input)
		b.Run("CloudTrail - pointers", func(b *testing.B) {
			b.ReportAllocs()
			event := &ptrCloudTrail{}
			for i := 0; i < b.N; i++ {
				*event = ptrCloudTrail{}
				if err := jsoniter.Unmarshal(raw, event); err != nil {
					b.Fatal(err)
				}
				_ = event
			}
		})
		b.Run("CloudTrail - null", func(b *testing.B) {
			b.ReportAllocs()
			event := &nullCloudTrail{}
			for i := 0; i < b.N; i++ {
				*event = nullCloudTrail{}
				if err := jsoniter.Unmarshal(raw, event); err != nil {
					b.Fatal(err)
				}
				_ = event
			}
		})
	}
	{
		// nolint:lll
		input := testutil.MustReadFileJSONLines(`../../parsers/gitlablogs/testdata/productionlog_samples.jsonl`)
		b.Run("GitLab - pointers", func(b *testing.B) {
			b.ReportAllocs()
			for i := 0; i < b.N; i++ {
				raw := input[i%len(input)]
				event := &ptrProduction{}
				if err := jsoniter.UnmarshalFromString(raw, event); err != nil {
					b.Fatal(err)
				}
				_ = event
			}
		})
		b.Run("GitLab - null", func(b *testing.B) {
			b.ReportAllocs()
			for i := 0; i < b.N; i++ {
				raw := input[i%len(input)]
				event := &nullProduction{}
				if err := jsoniter.UnmarshalFromString(raw, event); err != nil {
					b.Fatal(err)
				}
				_ = event
			}
		})
	}
}

// CloudTrail is a record from the Records[*] JSON of an AWS CloudTrail API log.
// nolint:lll
type ptrCloudTrail struct {
	AdditionalEventData *jsoniter.RawMessage       `json:"additionalEventData,omitempty" description:"Additional data about the event that was not part of the request or response."`
	APIVersion          *string                    `json:"apiVersion,omitempty" description:"Identifies the API version associated with the AwsApiCall eventType value."`
	AWSRegion           *string                    `json:"awsRegion,omitempty" validate:"required" description:"The AWS region that the request was made to, such as us-east-2."`
	ErrorCode           *string                    `json:"errorCode,omitempty" description:"The AWS service error if the request returns an error."`
	ErrorMessage        *string                    `json:"errorMessage,omitempty" description:"If the request returns an error, the description of the error. This message includes messages for authorization failures. CloudTrail captures the message logged by the service in its exception handling."`
	EventID             *string                    `json:"eventID,omitempty" validate:"required" description:"GUID generated by CloudTrail to uniquely identify each event. You can use this value to identify a single event. For example, you can use the ID as a primary key to retrieve log data from a searchable database."`
	EventName           *string                    `json:"eventName,omitempty" validate:"required" description:"The requested action, which is one of the actions in the API for that service."`
	EventSource         *string                    `json:"eventSource,omitempty" validate:"required" description:"The service that the request was made to. This name is typically a short form of the service name without spaces plus .amazonaws.com."`
	EventTime           *timestamp.RFC3339         `json:"eventTime,omitempty" validate:"required" description:"The date and time the request was made, in coordinated universal time (UTC)."`
	EventType           *string                    `json:"eventType,omitempty" validate:"required" description:"Identifies the type of event that generated the event record. This can be the one of the following values: AwsApiCall, AwsServiceEvent, AwsConsoleSignIn"`
	EventVersion        *string                    `json:"eventVersion,omitempty" validate:"required" description:"The version of the log event format."`
	ManagementEvent     *bool                      `json:"managementEvent,omitempty" description:"A Bool value that identifies whether the event is a management event. managementEvent is shown in an event record if eventVersion is 1.06 or higher, and the event type is one of the following: AwsApiCall, AwsConsoleAction, AwsConsoleSignIn,  AwsServiceEvent"`
	ReadOnly            *bool                      `json:"readOnly,omitempty" description:"Identifies whether this operation is a read-only operation."`
	RecipientAccountID  *string                    `json:"recipientAccountId,omitempty" validate:"omitempty,len=12,numeric" description:"Represents the account ID that received this event. The recipientAccountID may be different from the CloudTrail userIdentity Element accountId. This can occur in cross-account resource access."`
	RequestID           *string                    `json:"requestID,omitempty" description:"The value that identifies the request. The service being called generates this value."`
	RequestParameters   *jsoniter.RawMessage       `json:"requestParameters,omitempty" description:"The parameters, if any, that were sent with the request. These parameters are documented in the API reference documentation for the appropriate AWS service."`
	Resources           []ptrCloudTrailResources   `json:"resources,omitempty" description:"A list of resources accessed in the event."`
	ResponseElements    *jsoniter.RawMessage       `json:"responseElements,omitempty" description:"The response element for actions that make changes (create, update, or delete actions). If an action does not change state (for example, a request to get or list objects), this element is omitted. These actions are documented in the API reference documentation for the appropriate AWS service."`
	ServiceEventDetails *jsoniter.RawMessage       `json:"serviceEventDetails,omitempty" description:"Identifies the service event, including what triggered the event and the result."`
	SharedEventID       *string                    `json:"sharedEventID,omitempty" description:"GUID generated by CloudTrail to uniquely identify CloudTrail events from the same AWS action that is sent to different AWS accounts."`
	SourceIPAddress     *string                    `json:"sourceIPAddress,omitempty" validate:"required" description:"The IP address that the request was made from. For actions that originate from the service console, the address reported is for the underlying customer resource, not the console web server. For services in AWS, only the DNS name is displayed."`
	UserAgent           *string                    `json:"userAgent,omitempty" description:"The agent through which the request was made, such as the AWS Management Console, an AWS service, the AWS SDKs or the AWS CLI."`
	UserIdentity        *ptrCloudTrailUserIdentity `json:"userIdentity,omitempty" validate:"required" description:"Information about the user that made a request."`
	VPCEndpointID       *string                    `json:"vpcEndpointId,omitempty" description:"Identifies the VPC endpoint in which requests were made from a VPC to another AWS service, such as Amazon S3."`
}

// CloudTrailResources are the AWS resources used in the API call.
type ptrCloudTrailResources struct {
	ARN       *string `json:"arn"`
	AccountID *string `json:"accountId"`
	Type      *string `json:"type"`
}

// CloudTrailUserIdentity contains details about the type of IAM identity that made the request.
type ptrCloudTrailUserIdentity struct {
	Type             *string                      `json:"type,omitempty"`
	PrincipalID      *string                      `json:"principalId,omitempty"`
	ARN              *string                      `json:"arn,omitempty"`
	AccountID        *string                      `json:"accountId,omitempty"`
	AccessKeyID      *string                      `json:"accessKeyId,omitempty"`
	Username         *string                      `json:"userName,omitempty"`
	SessionContext   *ptrCloudTrailSessionContext `json:"sessionContext,omitempty"`
	InvokedBy        *string                      `json:"invokedBy,omitempty"`
	IdentityProvider *string                      `json:"identityProvider,omitempty"`
}

// CloudTrailSessionContext provides information about a session created for temporary credentials.
type ptrCloudTrailSessionContext struct {
	Attributes          *ptrCloudTrailSessionContextAttributes          `json:"attributes,omitempty"`
	SessionIssuer       *ptrCloudTrailSessionContextSessionIssuer       `json:"sessionIssuer,omitempty"`
	WebIDFederationData *ptrCloudTrailSessionContextWebIDFederationData `json:"webIdFederationData,omitempty"`
}

// CloudTrailSessionContextAttributes  contains the attributes of the Session context object
type ptrCloudTrailSessionContextAttributes struct {
	MfaAuthenticated *string `json:"mfaAuthenticated,omitempty"`
	CreationDate     *string `json:"creationDate,omitempty"`
}

// CloudTrailSessionContextSessionIssuer contains information for the SessionContextSessionIssuer
type ptrCloudTrailSessionContextSessionIssuer struct {
	Type        *string `json:"type,omitempty"`
	PrincipalID *string `json:"principalId,omitempty"`
	Arn         *string `json:"arn,omitempty"`
	AccountID   *string `json:"accountId,omitempty"`
	Username    *string `json:"userName,omitempty"`
}

// CloudTrailSessionContextWebIDFederationData contains Web ID federation data
type ptrCloudTrailSessionContextWebIDFederationData struct {
	FederatedProvider *string              `json:"federatedProvider,omitempty"`
	Attributes        *jsoniter.RawMessage `json:"attributes,omitempty"`
}

// CloudTrail is a record from the Records[*] JSON of an AWS CloudTrail API log.
// nolint:lll
type nullCloudTrail struct {
	AdditionalEventData jsoniter.RawMessage         `json:"additionalEventData,omitempty" description:"Additional data about the event that was not part of the request or response."`
	APIVersion          null.String                 `json:"apiVersion,omitempty" description:"Identifies the API version associated with the AwsApiCall eventType value."`
	AWSRegion           null.String                 `json:"awsRegion,omitempty" validate:"required" description:"The AWS region that the request was made to, such as us-east-2."`
	ErrorCode           null.String                 `json:"errorCode,omitempty" description:"The AWS service error if the request returns an error."`
	ErrorMessage        null.String                 `json:"errorMessage,omitempty" description:"If the request returns an error, the description of the error. This message includes messages for authorization failures. CloudTrail captures the message logged by the service in its exception handling."`
	EventID             null.String                 `json:"eventID,omitempty" validate:"required" description:"GUID generated by CloudTrail to uniquely identify each event. You can use this value to identify a single event. For example, you can use the ID as a primary key to retrieve log data from a searchable database."`
	EventName           null.String                 `json:"eventName,omitempty" validate:"required" description:"The requested action, which is one of the actions in the API for that service."`
	EventSource         null.String                 `json:"eventSource,omitempty" validate:"required" description:"The service that the request was made to. This name is typically a short form of the service name without spaces plus .amazonaws.com."`
	EventTime           timestamp.RFC3339           `json:"eventTime,omitempty" validate:"required" description:"The date and time the request was made, in coordinated universal time (UTC)."`
	EventType           null.String                 `json:"eventType,omitempty" validate:"required" description:"Identifies the type of event that generated the event record. This can be the one of the following values: AwsApiCall, AwsServiceEvent, AwsConsoleSignIn"`
	EventVersion        null.String                 `json:"eventVersion,omitempty" validate:"required" description:"The version of the log event format."`
	ManagementEvent     null.Bool                   `json:"managementEvent,omitempty" description:"A Bool value that identifies whether the event is a management event. managementEvent is shown in an event record if eventVersion is 1.06 or higher, and the event type is one of the following: AwsApiCall, AwsConsoleAction, AwsConsoleSignIn,  AwsServiceEvent"`
	ReadOnly            null.Bool                   `json:"readOnly,omitempty" description:"Identifies whether this operation is a read-only operation."`
	RecipientAccountID  null.String                 `json:"recipientAccountId,omitempty" validate:"omitempty,len=12,numeric" description:"Represents the account ID that received this event. The recipientAccountID may be different from the CloudTrail userIdentity Element accountId. This can occur in cross-account resource access."`
	RequestID           null.String                 `json:"requestID,omitempty" description:"The value that identifies the request. The service being called generates this value."`
	RequestParameters   jsoniter.RawMessage         `json:"requestParameters,omitempty" description:"The parameters, if any, that were sent with the request. These parameters are documented in the API reference documentation for the appropriate AWS service."`
	Resources           []nullCloudTrailResources   `json:"resources,omitempty" description:"A list of resources accessed in the event."`
	ResponseElements    jsoniter.RawMessage         `json:"responseElements,omitempty" description:"The response element for actions that make changes (create, update, or delete actions). If an action does not change state (for example, a request to get or list objects), this element is omitted. These actions are documented in the API reference documentation for the appropriate AWS service."`
	ServiceEventDetails jsoniter.RawMessage         `json:"serviceEventDetails,omitempty" description:"Identifies the service event, including what triggered the event and the result."`
	SharedEventID       null.String                 `json:"sharedEventID,omitempty" description:"GUID generated by CloudTrail to uniquely identify CloudTrail events from the same AWS action that is sent to different AWS accounts."`
	SourceIPAddress     null.String                 `json:"sourceIPAddress,omitempty" validate:"required" description:"The IP address that the request was made from. For actions that originate from the service console, the address reported is for the underlying customer resource, not the console web server. For services in AWS, only the DNS name is displayed."`
	UserAgent           null.String                 `json:"userAgent,omitempty" description:"The agent through which the request was made, such as the AWS Management Console, an AWS service, the AWS SDKs or the AWS CLI."`
	UserIdentity        *nullCloudTrailUserIdentity `json:"userIdentity,omitempty" validate:"required" description:"Information about the user that made a request."`
	VPCEndpointID       null.String                 `json:"vpcEndpointId,omitempty" description:"Identifies the VPC endpoint in which requests were made from a VPC to another AWS service, such as Amazon S3."`
}

// CloudTrailResources are the AWS resources used in the API call.
type nullCloudTrailResources struct {
	ARN       null.String `json:"arn"`
	AccountID null.String `json:"accountId"`
	Type      null.String `json:"type"`
}

// CloudTrailUserIdentity contains details about the type of IAM identity that made the request.
type nullCloudTrailUserIdentity struct {
	Type             null.String                   `json:"type,omitempty"`
	PrincipalID      null.String                   `json:"principalId,omitempty"`
	ARN              null.String                   `json:"arn,omitempty"`
	AccountID        null.String                   `json:"accountId,omitempty"`
	AccessKeyID      null.String                   `json:"accessKeyId,omitempty"`
	Username         null.String                   `json:"userName,omitempty"`
	SessionContext   *nullCloudTrailSessionContext `json:"sessionContext,omitempty"`
	InvokedBy        null.String                   `json:"invokedBy,omitempty"`
	IdentityProvider null.String                   `json:"identityProvider,omitempty"`
}

// CloudTrailSessionContext provides information about a session created for temporary credentials.
type nullCloudTrailSessionContext struct {
	Attributes          *nullCloudTrailSessionContextAttributes          `json:"attributes,omitempty"`
	SessionIssuer       *nullCloudTrailSessionContextSessionIssuer       `json:"sessionIssuer,omitempty"`
	WebIDFederationData *nullCloudTrailSessionContextWebIDFederationData `json:"webIdFederationData,omitempty"`
}

// CloudTrailSessionContextAttributes  contains the attributes of the Session context object
type nullCloudTrailSessionContextAttributes struct {
	MfaAuthenticated null.String `json:"mfaAuthenticated,omitempty"`
	CreationDate     null.String `json:"creationDate,omitempty"`
}

// CloudTrailSessionContextSessionIssuer contains information for the SessionContextSessionIssuer
type nullCloudTrailSessionContextSessionIssuer struct {
	Type        null.String `json:"type,omitempty"`
	PrincipalID null.String `json:"principalId,omitempty"`
	Arn         null.String `json:"arn,omitempty"`
	AccountID   null.String `json:"accountId,omitempty"`
	Username    null.String `json:"userName,omitempty"`
}

// CloudTrailSessionContextWebIDFederationData contains Web ID federation data
type nullCloudTrailSessionContextWebIDFederationData struct {
	FederatedProvider null.String         `json:"federatedProvider,omitempty"`
	Attributes        jsoniter.RawMessage `json:"attributes,omitempty"`
}

// nolint:lll
type ptrProduction struct {
	Method                *string            `json:"method" validate:"required" description:"The HTTP method of the request"`
	Path                  *string            `json:"path" validate:"required" description:"The URL path for the request"`
	Format                *string            `json:"format" description:"The response output format"`
	Controller            *string            `json:"controller,omitempty" description:"The Production controller class name"`
	Action                *string            `json:"action,omitempty" description:"The Production controller action"`
	Status                *int               `json:"status" validate:"required" description:"The HTTP response status code"`
	Time                  *timestamp.RFC3339 `json:"time" validate:"required" description:"The request timestamp"`
	Params                []ptrQueryParam    `json:"params,omitempty" description:"The URL query parameters"`
	RemoteIP              *string            `json:"remote_ip,omitempty" description:"The remote IP address of the HTTP request"`
	UserID                *int64             `json:"user_id,omitempty" description:"The user id of the request"`
	UserName              *string            `json:"username,omitempty" description:"The username of the request"`
	UserAgent             *string            `json:"ua,omitempty" description:"The User-Agent of the requester"`
	QueueDurationSeconds  *float32           `json:"queue_duration_s,omitempty" description:"Total time that the request was queued inside GitLab Workhorse"`
	GitalyCalls           *int               `json:"gitaly_calls,omitempty" description:"Total number of calls made to Gitaly"`
	GitalyDurationSeconds *float32           `json:"gitaly_duration_s,omitempty" description:"Total time taken by Gitaly calls"`
	RedisCalls            *int               `json:"redis_calls,omitempty" description:"Total number of calls made to Redis"`
	RedisDurationSeconds  *float32           `json:"redis_duration_s,omitempty" description:"Total time to retrieve data from Redis"`
	RedisReadBytes        *int64             `json:"redis_read_bytes,omitempty" description:"Total bytes read from Redis"`
	RedisWriteBytes       *int64             `json:"redis_write_bytes,omitempty" description:"Total bytes written to Redis"`
	CorrelationID         *string            `json:"correlation_id,omitempty" description:"Request unique id across logs"`
	CPUSeconds            *float32           `json:"cpu_s,omitempty" description:" Total time spent on CPU"`
	DBDurationSeconds     *float32           `json:"db_duration_s,omitempty" description:"Total time to retrieve data from PostgreSQL"`
	ViewDurationSeconds   *float32           `json:"view_duration_s,omitempty" description:" Total time taken inside the Rails views"`
	DurationSeconds       *float32           `json:"duration_s" validate:"required" description:"Total time taken to retrieve the request"`
	MetaCallerID          *string            `json:"meta.caller_id,omitempty" description:"Caller ID"`
	Location              *string            `json:"location" description:"(Applies only to redirects) The redirect URL"`
	ExceptionClass        *string            `json:"exception.class,omitempty" description:"Class name of the exception that occurred"`
	ExceptionMessage      *string            `json:"exception.message,omitempty" description:"Message of the exception that occurred"`
	ExceptionBacktrace    []string           `json:"exception.backtrace,omitempty" description:"Stack trace of the exception that occurred"`
}

// QueryParam is an HTTP query param as logged by LogRage
type ptrQueryParam struct {
	Key   *string             `json:"key" validate:"required" description:"Query parameter name"`
	Value jsoniter.RawMessage `json:"value,omitempty" description:"Query parameter value"`
}

// nolint:lll
type nullProduction struct {
	Method                null.String       `json:"method" validate:"required" description:"The HTTP method of the request"`
	Path                  null.String       `json:"path" validate:"required" description:"The URL path for the request"`
	Format                null.String       `json:"format" description:"The response output format"`
	Controller            null.String       `json:"controller,omitempty" description:"The Production controller class name"`
	Action                null.String       `json:"action,omitempty" description:"The Production controller action"`
	Status                null.Int32        `json:"status" validate:"required" description:"The HTTP response status code"`
	Time                  timestamp.RFC3339 `json:"time" validate:"required" description:"The request timestamp"`
	Params                []nullQueryParam  `json:"params,omitempty" description:"The URL query parameters"`
	RemoteIP              null.String       `json:"remote_ip,omitempty" description:"The remote IP address of the HTTP request"`
	UserID                null.Int64        `json:"user_id,omitempty" description:"The user id of the request"`
	UserName              null.String       `json:"username,omitempty" description:"The username of the request"`
	UserAgent             null.String       `json:"ua,omitempty" description:"The User-Agent of the requester"`
	QueueDurationSeconds  null.Float32      `json:"queue_duration_s,omitempty" description:"Total time that the request was queued inside GitLab Workhorse"`
	GitalyCalls           null.Int32        `json:"gitaly_calls,omitempty" description:"Total number of calls made to Gitaly"`
	GitalyDurationSeconds null.Float32      `json:"gitaly_duration_s,omitempty" description:"Total time taken by Gitaly calls"`
	RedisCalls            null.Int32        `json:"redis_calls,omitempty" description:"Total number of calls made to Redis"`
	RedisDurationSeconds  null.Float32      `json:"redis_duration_s,omitempty" description:"Total time to retrieve data from Redis"`
	RedisReadBytes        null.Int64        `json:"redis_read_bytes,omitempty" description:"Total bytes read from Redis"`
	RedisWriteBytes       null.Int64        `json:"redis_write_bytes,omitempty" description:"Total bytes written to Redis"`
	CorrelationID         null.String       `json:"correlation_id,omitempty" description:"Request unique id across logs"`
	CPUSeconds            null.Float32      `json:"cpu_s,omitempty" description:" Total time spent on CPU"`
	DBDurationSeconds     null.Float32      `json:"db_duration_s,omitempty" description:"Total time to retrieve data from PostgreSQL"`
	ViewDurationSeconds   null.Float32      `json:"view_duration_s,omitempty" description:" Total time taken inside the Rails views"`
	DurationSeconds       null.Float32      `json:"duration_s" validate:"required" description:"Total time taken to retrieve the request"`
	MetaCallerID          null.String       `json:"meta.caller_id,omitempty" description:"Caller ID"`
	Location              null.String       `json:"location" description:"(Applies only to redirects) The redirect URL"`
	ExceptionClass        null.String       `json:"exception.class,omitempty" description:"Class name of the exception that occurred"`
	ExceptionMessage      null.String       `json:"exception.message,omitempty" description:"Message of the exception that occurred"`
	ExceptionBacktrace    []string          `json:"exception.backtrace,omitempty" description:"Stack trace of the exception that occurred"`
}

// QueryParam is an HTTP query param as logged by LogRage
type nullQueryParam struct {
	Key   null.String         `json:"key" validate:"required" description:"Query parameter name"`
	Value jsoniter.RawMessage `json:"value,omitempty" description:"Query parameter value"`
}
